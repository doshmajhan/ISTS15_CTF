# Expected Ciphertext Shape:
# ENDYAHROHNLSRHEOCPTEOIBIDYSHNAIA
# CHTNREYULDSLLSLLNOHSNOSMRWXMNE
# TPRNGATIHNRARPESLNNELEBLPIIACAE
# WMTWNDITEENRAHCTENEUDRETNHAEOE
# TFOLSEDTIWENHAEIOYTEYQHEENCTAYCR
# EIFTBRSPAMHHEWENATAMATEGYEERLB
# TEEFOASFIOTUETUAEOTOARMAEERTNRTI
# BSEDDNIAAHTTMSTEWPIEROAGRIEWFEB
# AECTDDHILCEIHSITEGOEAOSDDRYDLORIT
# RKLMLEHAGTDHARDPNEOHMGFMFEUHE
# ECDMRIPFEIMEHNLSSTTRTVDOHW?
# (336 chars)
msg = "".join("""
SLOWLY DESPERATELY SLOWLY THE NUMERIC SHACKLES THAT ENCUMBERED THE OUTER PART OF THE FINAL MESSAGE WERE REMOVED
WITH TREMBLING HANDS I MADE A TINY BREACH IN THE UPPER LEFT CORNER AND THEN WIDENING THE HOLE IN A CIRCULAR FASHION
I PEERED IN AND DETAILS OF THE ROOM WITHIN EMERGED FROM THE MIST
THE FLAME DANCES AND IN THE SHADOWS A FIGURE APPEARS CRYING OUT HELP ME! HELP ME! OH AND BTW THE FLAG IS THESHADOWMAN
""".strip().split())
assert len(msg) == 336

def grid(text, cols, rows=None):
    text = "".join(text.split())
    grid = [text[n:n+cols] for n in range(0, len(text), cols)]

    # sanity check
    if rows:
        assert len(grid) == rows
    return grid


def rotate(grid, right=True):
    if right:
        new_grid = [
            "".join([row[col] for row in grid[::-1]]) for col in range(len(grid[0]))
            ]
    else:
        new_grid = [
            "".join([row[col] for row in grid]) for col in range(len(grid[0]))
        ][::-1]
    return new_grid


def decode(encoded):
    grid1 = "".join(rotate(grid(encoded, 24, 14), right=True))
    grid2 = "".join(rotate(grid(grid1, 8, 42), right=True))
    return grid2


def encode(plain):
    grid1 = "".join(rotate(grid(plain, 42, 8), right=False))
    grid2 = "".join(rotate(grid(grid1, 14, 24), right=False))
    return grid2


encoded = """ENDyaHrOHNLSRHEOCPTEOIBIDYSHNAIA
CHTNREYULDSLLSLLNOHSNOSMRWXMNE
TPRNGATIHNRARPESLNNELEBLPIIACAE
WMTWNDITEENRAHCTENEUDRETNHAEOE
TFOLSEDTIWENHAEIOYTEYQHEENCTAYCR
EIFTBRSPAMHNEWENATAMATEGYEERLB
TEEFOASFIOTUETUAEOTOARMAEERTNRTI
BSEDDNIAAHTTMSTEWPIEROAGRIEWFEB
AECTDDHILCEIHSITEGOEAOSDDRYDLORIT
RKLMLEHAGTDHARDPNEOHMGFMFEUHE
ECDMRIPFEIMEHNLSSTTRTVDOHW"""

plain = "SLOWLYDESPARATLYSLOWLYTHEREMAINSOFPASSAGEDEBRISTHATENCUMBEREDTHELOWERPArTOFTHEDOORWAYWASREMOVEDWITHTREMBLINGHANDSIMADEATINYBREACNINTHEUPPERLEFTHANDCORNERANDTHENWIDENINGTHEHOLEALITTLEIINSERTEDTHECANDLEANDPEEREDINTHEHOTAIRESCAPINGFROMTHECHAMBERCaUSEDTHEFLAMETOFLICKERBUTPRESENTLYDETAILSOFTHEROOMWITHINEMERGEDFROMTHEMISTXCANYOUSEEANyTHINGQ"
# print("Decoded: " + decode(encoded))
# print("Encoded: \n" + encode(plain))
# print("Expected: \n" + encoded)

CIPHER_3 = encode(msg)